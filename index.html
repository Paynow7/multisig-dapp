<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç­¾é’±åŒ…ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        h2 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
        
        .wallet-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .tab {
            display: none;
        }
        
        .tab.active {
            display: block;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 5px;
        }
        
        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            color: #666;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å¤šç­¾é’±åŒ…ç®¡ç†ç³»ç»Ÿ</h1>
        
        <div class="wallet-info">
            <div id="walletStatus">æœªè¿æ¥é’±åŒ…</div>
            <button onclick="connectWallet()" id="connectBtn">è¿æ¥ TronLink é’±åŒ…</button>
        </div>

        <div class="tab-buttons">
            <button class="tab-btn active" onclick="showTab('submit')">æäº¤äº¤æ˜“</button>
            <button class="tab-btn" onclick="showTab('confirm')">ç¡®è®¤äº¤æ˜“</button>
            <button class="tab-btn" onclick="showTab('execute')">æ‰§è¡Œäº¤æ˜“</button>
            <button class="tab-btn" onclick="showTab('view')">æŸ¥çœ‹çŠ¶æ€</button>
        </div>

        <!-- æäº¤äº¤æ˜“æ ‡ç­¾é¡µ -->
        <div id="submit" class="tab active">
            <div class="section">
                <h2>ğŸ“¤ æäº¤æ–°äº¤æ˜“</h2>
                <div class="input-group">
                    <label>æ”¶æ¬¾åœ°å€ï¼š</label>
                    <input type="text" id="toAddress" placeholder="è¾“å…¥TRONåœ°å€">
                </div>
                <div class="input-group">
                    <label>è½¬è´¦é‡‘é¢ (SUN)ï¼š</label>
                    <input type="number" id="amount" placeholder="1 TRX = 1,000,000 SUN">
                </div>
                <div class="input-group">
                    <label>ä»£å¸ç±»å‹ï¼š</label>
                    <select id="tokenType">
                        <option value="trx">TRX</option>
                        <option value="custom">TRC20 ä»£å¸</option>
                    </select>
                </div>
                <div class="input-group" id="tokenAddressGroup" style="display:none;">
                    <label>ä»£å¸åˆçº¦åœ°å€ï¼š</label>
                    <input type="text" id="tokenAddress" placeholder="è¾“å…¥TRC20åˆçº¦åœ°å€">
                </div>
                <button onclick="submitTransaction()">æäº¤äº¤æ˜“</button>
            </div>
        </div>

        <!-- ç¡®è®¤äº¤æ˜“æ ‡ç­¾é¡µ -->
        <div id="confirm" class="tab">
            <div class="section">
                <h2>âœ… ç¡®è®¤äº¤æ˜“</h2>
                <div class="input-group">
                    <label>äº¤æ˜“IDï¼š</label>
                    <input type="number" id="confirmTxId" placeholder="è¾“å…¥äº¤æ˜“ID">
                </div>
                <button onclick="confirmTransaction()">ç¡®è®¤äº¤æ˜“</button>
            </div>
        </div>

        <!-- æ‰§è¡Œäº¤æ˜“æ ‡ç­¾é¡µ -->
        <div id="execute" class="tab">
            <div class="section">
                <h2>ğŸš€ æ‰§è¡Œäº¤æ˜“</h2>
                <div class="input-group">
                    <label>äº¤æ˜“IDï¼š</label>
                    <input type="number" id="executeTxId" placeholder="è¾“å…¥äº¤æ˜“ID">
                </div>
                <button onclick="executeTransaction()">æ‰§è¡Œäº¤æ˜“</button>
            </div>
        </div>

        <!-- æŸ¥çœ‹çŠ¶æ€æ ‡ç­¾é¡µ -->
        <div id="view" class="tab">
            <div class="section">
                <h2>ğŸ“Š åˆçº¦çŠ¶æ€</h2>
                <button onclick="loadContractInfo()">åˆ·æ–°çŠ¶æ€</button>
                <div id="contractInfo" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div id="status" class="status"></div>
    </div>

    <script>
        // å¤šç­¾åˆçº¦é…ç½®
        const CONTRACT_ADDRESS = 'TTaRM4VnJ1vksC6ofkYjxr24yyxjuSKAuj';
        const CONTRACT_ABI = [
            {
                "inputs": [
                    {"internalType": "address", "name": "_to", "type": "address"},
                    {"internalType": "uint256", "name": "_value", "type": "uint256"},
                    {"internalType": "address", "name": "_token", "type": "address"},
                    {"internalType": "bytes", "name": "_data", "type": "bytes"}
                ],
                "name": "submitTransaction",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_txId", "type": "uint256"}],
                "name": "confirmTransaction",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_txId", "type": "uint256"}],
                "name": "executeTransaction",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getOwners",
                "outputs": [{"internalType": "address[]", "name": "", "type": "address[]"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getTransactionCount",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getContractBalance",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        let contract;
        let currentAddress;

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // ä»£å¸ç±»å‹åˆ‡æ¢
        document.getElementById('tokenType').addEventListener('change', function() {
            const tokenAddressGroup = document.getElementById('tokenAddressGroup');
            tokenAddressGroup.style.display = this.value === 'custom' ? 'block' : 'none';
        });

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (typeof window.tronWeb === 'undefined') {
                    showStatus('è¯·å®‰è£… TronLink é’±åŒ…', 'error');
                    return;
                }

                // è¯·æ±‚è´¦æˆ·è®¿é—®
                await window.tronWeb.request({method: 'tron_requestAccounts'});
                
                currentAddress = window.tronWeb.defaultAddress.base58;
                document.getElementById('walletStatus').innerHTML = `å·²è¿æ¥: ${currentAddress}`;
                document.getElementById('connectBtn').style.display = 'none';
                
                // åˆ›å»ºåˆçº¦å®ä¾‹
                contract = await window.tronWeb.contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                
                showStatus('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
                
                // åŠ è½½åˆçº¦ä¿¡æ¯
                await loadContractInfo();
                
            } catch (error) {
                showStatus('è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æäº¤äº¤æ˜“
      async function submitTransaction() {
    if (!contract) {
        showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
        return;
    }

    const toAddress = document.getElementById('toAddress').value;
    const amount = document.getElementById('amount').value;
    const tokenType = document.getElementById('tokenType').value;
    const tokenAddress = tokenType === 'custom' ? document.getElementById('tokenAddress').value : '0x0000000000000000000000000000000000000000';

    if (!toAddress || !amount) {
        showStatus('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
        return;
    }

    try {
        showStatus('æäº¤äº¤æ˜“ä¸­...', 'info');
        
        // æäº¤äº¤æ˜“
        await contract.submitTransaction(
            toAddress,
            amount,
            tokenAddress,
            '0x'
        ).send();
        
        // è·å–æœ€æ–°çš„äº¤æ˜“IDï¼ˆäº¤æ˜“æ•°é‡-1ï¼‰
        const txCount = await contract.getTransactionCount().call();
        const txId = Number(txCount) - 1;
        
        showStatus(`äº¤æ˜“æäº¤æˆåŠŸï¼äº¤æ˜“ID: ${txId}`, 'success');
        
        // æ¸…ç©ºè¡¨å•
        document.getElementById('toAddress').value = '';
        document.getElementById('amount').value = '';
        
    } catch (error) {
        showStatus('æäº¤å¤±è´¥: ' + error.message, 'error');
    }
}
// æ·»åŠ è¿™ä¸ªå‡½æ•°æ¥æå–äº¤æ˜“ID
async function getTransactionIdFromResult(result) {
    try {
        // æ–¹æ³•1ï¼šä»äº‹ä»¶æ—¥å¿—ä¸­è·å–
        // æ–¹æ³•2ï¼šè°ƒç”¨ getTransactionCount() - 1
        const txCount = await contract.getTransactionCount().call();
        return txCount - 1; // æœ€æ–°æäº¤çš„äº¤æ˜“ID
    } catch (error) {
        // å¦‚æœè·å–å¤±è´¥ï¼Œè¿”å›ä¸€ä¸ªæç¤º
        return 'è¯·æŸ¥çœ‹äº¤æ˜“è®¡æ•°';
    }
}

        // ç¡®è®¤äº¤æ˜“
        async function confirmTransaction() {
            if (!contract) {
                showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }

            const txId = document.getElementById('confirmTxId').value;
            
            if (!txId) {
                showStatus('è¯·è¾“å…¥äº¤æ˜“ID', 'error');
                return;
            }

            try {
                showStatus('ç¡®è®¤äº¤æ˜“ä¸­...', 'info');
                
                await contract.confirmTransaction(txId).send();
                
                showStatus('äº¤æ˜“ç¡®è®¤æˆåŠŸï¼', 'success');
                document.getElementById('confirmTxId').value = '';
                
            } catch (error) {
                showStatus('ç¡®è®¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ‰§è¡Œäº¤æ˜“
        async function executeTransaction() {
            if (!contract) {
                showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }

            const txId = document.getElementById('executeTxId').value;
            
            if (!txId) {
                showStatus('è¯·è¾“å…¥äº¤æ˜“ID', 'error');
                return;
            }

            try {
                showStatus('æ‰§è¡Œäº¤æ˜“ä¸­...', 'info');
                
                await contract.executeTransaction(txId).send();
                
                showStatus('äº¤æ˜“æ‰§è¡ŒæˆåŠŸï¼èµ„é‡‘å·²è½¬å‡º', 'success');
                document.getElementById('executeTxId').value = '';
                
            } catch (error) {
                showStatus('æ‰§è¡Œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½åˆçº¦ä¿¡æ¯
       async function loadContractInfo() {
    if (!contract) return;

    try {
        const owners = await contract.getOwners().call();
        const txCount = await contract.getTransactionCount().call();
        const balance = await contract.getContractBalance().call();
        
        // ä¿®å¤ï¼šå°† BigInt è½¬æ¢ä¸º Number
        const balanceTRX = (Number(balance) / 1000000).toFixed(6);
        const displayTxCount = Number(txCount);
        
        let transactionInfo = '';
        
        // æ˜¾ç¤ºæ‰€æœ‰äº¤æ˜“çŠ¶æ€
        for (let i = 0; i < displayTxCount; i++) {
            const isConfirmed = await contract.isTransactionConfirmed(i).call();
            const confirmedWeight = await contract.getConfirmedWeight(i).call();
            const tx = await contract.transactions(i).call();
            
            // ä¿®å¤ï¼šè½¬æ¢æ‰€æœ‰æ•°å€¼ç±»å‹
            transactionInfo += `
                <div style="margin: 10px 0; padding: 10px; background: #fff; border-radius: 5px;">
                    <strong>äº¤æ˜“ #${i}:</strong><br>
                    - ç›®æ ‡åœ°å€: ${tx.to}<br>
                    - é‡‘é¢: ${Number(tx.value)} SUN<br>
                    - å·²æ‰§è¡Œ: ${tx.executed ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>
                    - ç¡®è®¤æƒé‡: ${Number(confirmedWeight)}/8<br>
                    - çŠ¶æ€: ${isConfirmed ? 'âœ… å¯æ‰§è¡Œ' : 'â³ ç­‰å¾…ç¡®è®¤'}
                </div>
            `;
        }
        
        const info = `
            <strong>åˆçº¦åœ°å€:</strong> ${CONTRACT_ADDRESS}<br>
            <strong>åˆçº¦ä½™é¢:</strong> ${balanceTRX} TRX<br>
            <strong>äº¤æ˜“æ•°é‡:</strong> ${displayTxCount}<br>
            <strong>æˆå‘˜æ•°é‡:</strong> ${owners.length}<br>
            <strong>å½“å‰ç”¨æˆ·:</strong> ${currentAddress}<br>
            <strong>ç”¨æˆ·èº«ä»½:</strong> ${owners.includes(currentAddress) ? 'ğŸ‘‘ æˆå‘˜' : 'ğŸ‘¥ è§‚å¯Ÿè€…'}<br>
            <br>
            <strong>äº¤æ˜“çŠ¶æ€:</strong>
            ${transactionInfo || 'æš‚æ— äº¤æ˜“'}
        `;
        
        document.getElementById('contractInfo').innerHTML = info;
        
    } catch (error) {
        document.getElementById('contractInfo').innerHTML = 'åŠ è½½å¤±è´¥: ' + error.message;
    }
}
        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å°è¯•è¿æ¥é’±åŒ…
        window.addEventListener('load', async function() {
            if (typeof window.tronWeb !== 'undefined' && window.tronWeb.ready) {
                await connectWallet();
            }
        });
    </script>
</body>

</html>

